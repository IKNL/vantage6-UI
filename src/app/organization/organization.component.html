<div *ngIf="userPermission.hasPermission('view', 'organization', 'global') || userPermission.hasPermission('view', 'organization', 'collaboration')">
  <mat-card>
    Select organization:
    <div class="inline">
      <div ngbDropdown class="d-inline-block">
        <button class="btn btn-dropdown" id="dropdownOrgs" ngbDropdownToggle>{{current_organization.name}}</button>
        <div ngbDropdownMenu aria-labelledby="dropdownOrgs">
          <div *ngFor="let org of organizations">
            <button ngbDropdownItem (click)="selectOrganizationDropdown(org.id)">{{org.name}}</button>
          </div>
        </div>
      </div>
    </div>
  </mat-card>
</div>
<div *ngIf="current_organization.id!==-1">
  <div class="row justify-content-md-center">
    <div class="col-lg">
      <mat-card>
        <h3>{{current_organization.name}}</h3>
        <address>
          {{current_organization.address1}}<br/>
          {{current_organization.address2}}<br/>
          {{current_organization.country}}<br/>
          {{current_organization.domain}}
        </address>
        <br/>
        <!-- TODO show button with 'show public key' or so to display public key
        {{current_organization.public_key}}
        <br/>
        -->
        <button *ngIf="can('edit', 'organization')" mat-button class="btn-edit">
          Edit
        </button>
      </mat-card>

      <mat-card>
        <h4>Roles</h4>
        <div *ngIf="can('create', 'role')" class="inline">
          <button mat-button class="btn-add btn-right">
            <mat-icon>add_circle</mat-icon>
            <span>New role</span>
          </button>
        </div>
        <div *ngIf="current_org_role_count===0">
          <div *ngIf="can('view', 'role'); else noRolesBlock">
            You do not have permission to view the roles!
          </div>
          <ng-template #noRolesBlock>
            This organization has no roles!
          </ng-template>
        </div>
        <div *ngFor="let role of roles">
          <div *ngIf="(role.organization_id === current_organization.id) ||
                      (role.organization_id === null && current_organization.id === 1)">
            <mat-expansion-panel>
              <mat-expansion-panel-header>
                <mat-panel-title>
                  {{role.name}}
                </mat-panel-title>
              </mat-expansion-panel-header>
              <table style="width: 100%">
                <colgroup>
                  <col span="1" style="width: 20%;"/>
                  <col span="1" style="width: 80%;"/>
                </colgroup>
                <tr>
                  <td>Description:</td>
                  <td>{{role.description}}</td>
                </tr>
              </table>
              This role gives the following permissions:
              <app-permission-table
                [given_roles]="[role]"
                [given_rules]="[]"
                [loggedin_user_rules]="userPermission.userRules"
                [is_edit_mode]="false"
              ></app-permission-table>
            </mat-expansion-panel>
          </div>
        </div>
      </mat-card>
    </div>

    <div class="col-lg">
      <mat-card>
        <h4>Users</h4>
        <div *ngIf="can('create', 'user')" class="inline">
          <button mat-button class="btn-add btn-right" (click)="createUser()">
            <mat-icon>add_circle</mat-icon>
            <span>New user</span>
          </button>
        </div>
        <div *ngIf="organization_users.length===0">
          <div *ngIf="can('view', 'user'); else noUsersBlock">
            You do not have permission to view the users!
          </div>
          <ng-template #noUsersBlock>
            This organization has no users!
          </ng-template>
        </div>
        <div *ngFor="let user of organization_users; let idx = index">
          <mat-expansion-panel [expanded]="user.is_being_created">
            <mat-expansion-panel-header>
              <mat-panel-title>
                {{user.first_name}} {{user.last_name}}
              </mat-panel-title>
              <mat-panel-description>
                <div *ngIf="user.is_logged_in">
                  It's you!
                </div>
              </mat-panel-description>
            </mat-expansion-panel-header>
            <div *ngIf="!user.is_being_edited && !user.is_being_created; else editBlock">
              <app-user-view
                [user]="user"
                (deletingUser)="deleteUser($event)"
                (editingUser)="editUser($event)"
              ></app-user-view>
            </div>
            <ng-template #editBlock>
              <app-user-edit
                [user]="user"
                [roles_assignable]="roles_assignable"
                (finishedEditing)="endUserEditing($event, user, idx)"
                (cancelNewUser)="cancelNewUser($event)"
                (newlyCreatedUserId)="addNewlyCreatedUser($event, user)"
              ></app-user-edit>
            </ng-template>
          </mat-expansion-panel>
        </div>
      </mat-card>
    </div>
  </div>
</div>